#+STARTUP:
* 基本設定
** 本当の基本設定
#+BEGIN_SRC emacs-lisp
;;; init.el:
(when (< emacs-major-version 23)
  (defvar user-emacs-directory "~/.emacs.d/"))

; システムに装飾キー渡さない
(setq mac-pass-control-to-system nil)
(setq mac-pass-command-to-system nil)
(setq mac-pass-option-to-system nil)
(setq make-backup-files nil)
(setq auto-save-default nil)
(setq auto-save-list-file-prefix nil)
(setq create-lockfiles nil)
#+end_src
** C-tでバッファを切り変える
#+begin_src emacs-lisp
(define-key global-map (kbd "C-t") 'other-window)
#+end_src
** C-x C-cでEmacsを終了しない
#+begin_src emacs-lisp
(global-set-key (kbd "C-x C-c") 'magit)
(global-set-key (kbd "C-x C-z") 'your-favorite-command)
;; I never use C-x C-c
(defalias 'exit 'save-buffers-kill-emacs)
#+end_src
** 何かサーバーが動くらしい
行番号を表示しない、スクロールバーを表示しない、時間を24時間フォーマットで表示する
#+begin_src emacs-lisp
(server-start)
(column-number-mode -1)
(scroll-bar-mode -1)
(size-indication-mode t)
(setq display-time-24hr-format t)
(display-time-mode t)
#+end_src
** 日本語にする
文字コードはutf-8
#+begin_src emacs-lisp
(set-language-environment "Japanese")
(prefer-coding-system 'utf-8)
(setq frame-title-format "%f")
;; EmacsのデフォルトエンコーディングをUTF-8に設定
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(set-selection-coding-system 'utf-8)
#+end_src
** タブは4文字
#+begin_src emacs-lisp
(setq-default tab-width 4)
(setq-default indent-tabs-mode nil)
#+end_src
** フォントはMenloを使用する
#+begin_src emacs-lisp
(set-face-attribute 'default nil
                    :family "udev-gothic"
                    :height 200)
#+end_src
** 中間ファイルを生成しない(はず)
#+begin_src emacs-lisp
(setq backup-directory-alist
      `((".*".,temporary-file-directory)))
(setq auto-save-file-name-transforms
      `((".*" ,temporary-file-directory)))
#+end_src

#+begin_src emacs-lisp
(global-auto-revert-mode t)

(add-hook 'after-save-hook
          'executable-make-buffer-file-executable-if-script-p)
#+end_src

** M-*をmacのcommandキーにマップする
#+begin_src emacs-lisp
(setq mac-command-modifier 'meta)
#+end_src

** yes or noをy、nにする
#+begin_src emacs-lisp
(add-hook 'emacs-startup-hook
          #'(lambda ()
              (fset 'yes-or-no-p 'y-or-n-p)))
#+end_src

** Native Comp周りの設定
#+begin_src emacs-lisp
(with-eval-after-load 'comp-run
  ;; config
  (setopt native-comp-async-jobs-number 8)
  (setopt native-comp-speed 3)
  (setopt native-comp-always-compile t))

(with-eval-after-load 'warnings
  ;; config
  (setopt warning-suppress-types '((comp))))

(defun my/emacs-lisp-mode-hooks ()
  "list-mode-hooks"
  (when (require 'eldoc nil t)
    (setq eldoc-idle-delay 0.2)
    (setq eldoc-echo-area-use-multiline-p t)
    (turn-on-eldoc-mode)))
(add-hook 'emacs-lisp-mode-hook #'my/emacs-lisp-mode-hooks)
#+end_src

** 環境変数の設定
#+begin_src emacs-lisp
;; load environment value
(dolist (path (reverse (split-string (getenv "PATH") ":")))
  (add-to-list 'exec-path path))
#+end_src

** シェルの設定
#+begin_src emacs-lisp
(setq-default shell-file-name
              (expand-file-name "~/.nix-profile/bin/fish"))
(setq-default sh-shell-file
              (expand-file-name "~/.nix-profile/bin/fish"))
#+end_src

** Melpaの設定
#+begin_src emacs-lisp
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)
#+end_src

** reload init.el
#+begin_src emacs-lisp
(defun reload-init-file ()
  "reload init.el"
  (interactive)
  (load-file (format "%s/.emacs.d/init.el" (getenv "HOME"))))
#+end_src
* Utils

** moccur
#+begin_src emacs-lisp
(defadvice moccur-edit-change-file
    (after save-after-moccur-edit-buffer activate)
  (save-buffer))
#+end_src

** theme(catppuccin-theme)
#+begin_src emacs-lisp
(require 'catppuccin-theme)
(setq catppuccin-flavor 'latte)
(load-theme 'catppuccin t)
#+end_src

** volatile-highlights
#+begin_src emacs-lisp
(require 'volatile-highlights)
(add-hook 'emacs-startup-hook #'volatile-highlights-mode)
#+end_src

** cua-mode
#+begin_src emacs-lisp
(cua-mode t)
(setq cua-enable-cua-keys nil)
#+end_src

** exec-path-from-shell
#+begin_src emacs-lisp
(require 'exec-path-from-shell)
(setopt exec-path-from-shell-variables '("PATH" "GOPATH" "JAVA_HOME" "SHELL" "COPILOT_LANGUAGE_SERVER_PATH"))
(exec-path-from-shell-initialize)
#+end_src

** projectile.el
#+begin_src emacs-lisp
(require 'projectile)
(add-hook 'emacs-startup-hook #'projectile-mode)

(keymap-global-set "C-c p" #'projectile-command-map)


(defun add-prefix-to-list (prefix string-list)
  (mapcar (lambda (s) (concat prefix s)) string-list))

(with-eval-after-load 'projectile
  (setopt projectile-sort-order 'recently-active)
  (add-to-list 'projectile-project-root-files ".projectile")
  (add-to-list 'projectile-known-projects
               "~/Documents/org-mode/")
  (add-to-list 'projectile-known-projects
               "~/dotfiles/")
  (dolist
      (dir
       (add-prefix-to-list "~/ghq/" (split-string
                                     (string-trim
                                      (shell-command-to-string "ghq list"))
                                     "\n" t)))
    (add-to-list 'projectile-known-projects
                 (format "%s/" dir))))
#+end_src

** bufferlo.el
#+begin_src emacs-lisp
(require 'bufferlo)
(add-hook 'emacs-startup-hook #'bufferlo-mode)
#+end_src

** expand region
#+begin_src emacs-lisp
(require 'expand-region)
(global-set-key (kbd "C-=") 'er/expand-region)
#+end_src

** undo-tree
#+begin_src emacs-lisp
(require 'undo-tree)
(add-hook 'emacs-startup-hook #'global-undo-tree-mode)
(with-eval-after-load 'undo-tree
  (keymap-global-set "C-x u" #'undo-tree-visualize)
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo"))))
#+end_src

** git-gutter.el
#+begin_src emacs-lisp
(require 'git-gutter)
(add-hook 'emacs-startup-hook #'global-git-gutter-mode)
#+end_src

** rainbow-delimiters.el
#+begin_src emacs-lisp
(require 'rainbow-delimiters)
(add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
#+end_src

** hl-line.el
#+begin_src emacs-lisp
(require 'hl-line)
(add-hook 'emacs-startup-hook #'global-hl-line-mode)
#+end_src
** free-keys.el
#+begin_src emacs-lisp
(require 'free-keys)
#+end_src

** puni.el
#+begin_src emacs-lisp
(require 'puni)
(add-hook 'emacs-startup-hook #'puni-global-mode)
(electric-pair-mode 1)
#+end_src

** autorevert.el
#+begin_src emacs-lisp
(require 'autorevert)
(add-hook 'emacs-startup-hook #'global-auto-revert-mode)
#+end_src

** simple
#+begin_src emacs-lisp
  (require 'simple)
  (with-eval-after-load 'simple
    (setopt kill-whole-line t)
    (setopt kill-read-only-ok t))
#+end_src

** nano-modeline
#+begin_src emacs-lisp
(require 'nano-modeline)
(add-hook 'prog-mode-hook            #'nano-modeline-prog-mode)
(add-hook 'text-mode-hook            #'nano-modeline-text-mode)
(add-hook 'org-mode-hook             #'nano-modeline-org-mode)
(add-hook 'pdf-view-mode-hook        #'nano-modeline-pdf-mode)
(add-hook 'mu4e-headers-mode-hook    #'nano-modeline-mu4e-headers-mode)
(add-hook 'mu4e-view-mode-hook       #'nano-modeline-mu4e-message-mode)
(add-hook 'elfeed-show-mode-hook     #'nano-modeline-elfeed-entry-mode)
(add-hook 'elfeed-search-mode-hook   #'nano-modeline-elfeed-search-mode)
(add-hook 'term-mode-hook            #'nano-modeline-term-mode)
(add-hook 'xwidget-webkit-mode-hook  #'nano-modeline-xwidget-mode)
(add-hook 'messages-buffer-mode-hook #'nano-modeline-message-mode)
(add-hook 'org-capture-mode-hook     #'nano-modeline-org-capture-mode)
(add-hook 'org-agenda-mode-hook      #'nano-modeline-org-agenda-mode)
#+end_src

** moody
#+begin_src emacs-lisp
(require 'moody)
(setq x-underline-at-descent-line t)
(moody-replace-mode-line-buffer-identification)
(moody-replace-vc-mode)
;; 以下を追加
(when (eq system-type 'darwin)
  (setq moody-slant-function 'moody-slant-apple-rgb))
#+end_src

** minions
#+begin_src emacs-lisp
(require 'minions)
(minions-mode)
(setq minions-mode-line-lighter "[+]")
#+end_src

** which-key
#+begin_src emacs-lisp
(require 'which-key)
(add-hook 'emacs-startup-hook #'which-key-mode)
#+end_src

** magit
#+begin_src emacs-lisp
(require 'magit)
#+end_src
** olivetti-mode

#+begin_src emacs-lisp
(require 'olivetti)
#+end_src

** dashboard
#+begin_src emacs-lisp
(require 'dashboard)
(dashboard-setup-startup-hook)
#+end_src

** gcmh
#+begin_src emacs-lisp
(require 'gcmh)
(setq gcmh-verbose t)

#+end_src
** beacon
#+begin_src emacs-lisp
(require 'beacon)
(beacon-mode 1)
#+end_src

** dmacro
#+begin_src emacs-lisp
(setq dmacro-key (kbd "C-c e"))
(require 'dmacro)
(global-dmacro-mode t)
#+end_src
** instant-maximized-window
#+begin_src emacs-lisp
(require 'instant-maximized-window)
(keymap-global-set "C-c m" #'window-temp-maximize)
#+end_src
** symbol overlay
#+begin_src emacs-lisp
(require 'symbol-overlay)
#+end_src
** color-idendifiers-mode
#+begin_src emacs-lisp
(add-hook 'after-init-hook 'global-color-identifiers-mode)
#+end_src
** neotree
#+begin_src emacs-lisp
(require 'neotree)
(defun neotree-project-dir ()
  "Open NeoTree using the git root."
  (interactive)
  (let ((project-dir (projectile-project-root))
        (file-name (buffer-file-name)))
    (neotree-toggle)
    (if project-dir
        (if (neo-global--window-exists-p)
            (progn
              (neotree-dir project-dir)
              (neotree-find file-name)))
      (message "Could not find git project root."))))
;(setq projectile-switch-project-action 'neotree-projectile-action)
(keymap-global-set "M-n" #'neotree-project-dir)

(with-eval-after-load 'major-mode-hydra 
  (major-mode-hydra-define neotree-mode
                    (:title "edit" :color blue :quit-key "q" :foreign-key warn :separator "-")
                    ("Navi"
                     (("u" neotree-select-up-node "Up")
                      ("g" neotree-refresh "Refresh")
                      ("Q" neotree-hide "Hide"))
                     "File"
                     (("a" neo-open-file-ace-window "Ace")
                      ("n" neotree-create-node "Create")
                      ("r" neotree-rename-node "Rename")
                      ("c" neotree-copy-node "Copy")
                      ("d" neotree-delete-node "Delete")
                      ("SPC" neotree-quick-look))
                     "Toggle"
                     (("z" neotree-stretch-toggle     "Size"        :toggle (not (neo-window--minimize-p)))
                      ("h" neotree-hidden-file-toggle "Hidden file" :toggle neo-buffer--show-hidden-file-p)))))
#+end_src
** nerd-icons
#+begin_src emacs-lisp
(require 'nerd-icons)
(setq nerd-icons-font-family "Symbols Nerd Font Mono")
; (add-hook 'emact-startup-hook #'nerd-icons-completion-mode)
(nerd-icons-completion-mode)
#+end_src
** tree-sitter
#+begin_src emacs-lisp
;; Treesitの設定
(setq treesit-language-source-alist
      '((json "https://github.com/tree-sitter/tree-sitter-json")
        (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
        (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
        (go "https://github.com/tree-sitter/tree-sitter-go")
        (gomod "https://github.com/camdencheek/tree-sitter-go-mod")
        (python "https://github.com/tree-sitter/tree-sitter-python")
        (typst "https://github.com/uben0/tree-sitter-typst")
        ))
;; Treesitがインストールされてない場合は自動でインストールする
(dolist (element treesit-language-source-alist)
  (let* ((lang (car element)))
    (if (treesit-language-available-p lang)
        (message "treesit: %s is already installed" lang)
      (message "treesit: %s is not installed" lang)
      (treesit-install-language-grammar lang))))
#+end_src
** all-the-icons
#+begin_src emacs-lisp
(require 'all-the-icons)
#+end_src
* Completion
** corfu
#+begin_src emacs-lisp
(require 'corfu)
(corfu-popupinfo-mode 1)
(corfu-history-mode 1)
(add-hook 'emacs-startup-hook #'global-corfu-mode)
;;(add-hook 'org-mode-hook #'corfu-mode)
(with-eval-after-load 'corfu
  (setq corfu-auto t
        corfu-auto-delay 0.1
        corfu-cycle t
        corfu-auto-prefix 3
        text-mode-ispell-word-completion nil
        corfu-popupinfo-delay 0.3))
#+end_src

** cape
#+begin_src emacs-lisp
(defvar completion-at-point-functions '(tags-completion-at-point-function))
(require 'cape)
;(add-to-list 'completion-at-point-functions #'cape-dabbrev)
(add-to-list 'completion-at-point-functions #'cape-dict)
(add-to-list 'completion-at-point-functions #'cape-file)
(add-to-list 'completion-at-point-functions #'cape-history)
(add-to-list 'completion-at-point-functions #'cape-elisp-block)
(add-to-list 'completion-at-point-functions #'cape-tex)
(add-to-list 'completion-at-point-functions #'cape-emoji)
#+end_src

** nerd-icons-corfu
#+begin_src emacs-lisp
(add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter)
#+end_src
** vertico
#+begin_src emacs-lisp
(savehist-mode)
(require 'vertico)
(add-hook 'emacs-startup-hook #'vertico-mode)
(advice-add #'vertico--setup :after
            (lambda (&rest _)
              (setq-local completion-auto-help nil
                          completion-show-inline-help nil)))
#+end_src

** marginalia
#+begin_src emacs-lisp
(require 'marginalia)
(add-hook 'emacs-startup-hook #'marginalia-mode)
(add-hook 'marginalia-mode-hook #'nerd-icons-completion-marginalia-setup)
#+end_src

** avy
#+begin_src emacs-lisp
(require 'avy)
(require 'avy-zap)
#+end_src

** consult
#+begin_src emacs-lisp
(defvar my-consult--source-buffer
  `(:name "Other Buffers"
    :narrow   ?b
    :category buffer
    :face     consult-buffer
    :history  buffer-name-history
    :state    ,#'consult--buffer-state
    :items ,(lambda () (consult--buffer-query
                        :predicate #'bufferlo-non-local-buffer-p
                        :sort 'visibility
                        :as #'buffer-name)))
    "Non-local buffer candidate source for `consult-buffer'.")

(defvar my-consult--source-local-buffer
  `(:name "Local Buffers"
    :narrow   ?l
    :category buffer
    :face     consult-buffer
    :history  buffer-name-history
    :state    ,#'consult--buffer-state
    :default  t
    :items ,(lambda () (consult--buffer-query
                        :predicate #'bufferlo-local-buffer-p
                        :sort 'visibility
                        :as #'buffer-name)))
    "Local buffer candidate source for `consult-buffer'.")
(defun c/consult-line (&optional at-point)
    "Consult-line uses things-at-point if set C-u prefix."
    (interactive "P")
    (if at-point
        (consult-line (thing-at-point 'symbol))
      (consult-line)))

(require 'consult)
(keymap-global-set "C-x b" #'consult-buffer)
#+end_src

** embark
#+begin_src emacs-lisp
(require 'embark)
(keymap-global-set "C-." #'embark-act)
(keymap-global-set "C-;" #'embark-dwim)

(add-to-list 'display-buffer-alist
             '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
               nil
               (window-parameters (mode-line-format . none))))

(require 'embark-consult)

(defun embark-which-key-indicator ()
  "An embark indicator that displays keymaps using which-key.
The which-key help message will show the type and value of the
current target followed by an ellipsis if there are further
targets."
  (lambda (&optional keymap targets prefix)
    (if (null keymap)
        (which-key--hide-popup-ignore-command)
      (which-key--show-keymap
       (if (eq (plist-get (car targets) :type) 'embark-become)
           "Become"
         (format "Act on %s '%s'%s"
                 (plist-get (car targets) :type)
                 (embark--truncate-target (plist-get (car targets) :target))
                 (if (cdr targets) "…" "")))
       (if prefix
           (pcase (lookup-key keymap prefix 'accept-default)
             ((and (pred keymapp) km) km)
             (_ (key-binding prefix 'accept-default)))
         keymap)
       nil nil t (lambda (binding)
                   (not (string-suffix-p "-argument" (cdr
binding))))))))

(setq embark-indicators
  '(embark-which-key-indicator
    embark-highlight-indicator
    embark-isearch-highlight-indicator))

(defun embark-hide-which-key-indicator (fn &rest args)
  "Hide the which-key indicator immediately when using the completing-read prompter."
  (which-key--hide-popup-ignore-command)
  (let ((embark-indicators
         (remq #'embark-which-key-indicator embark-indicators)))
      (apply fn args)))

(advice-add #'embark-completing-read-prompter
            :around #'embark-hide-which-key-indicator)
#+end_src

** affe
#+begin_src emacs-lisp
(require 'affe)
(with-eval-after-load 'affe
  (setopt affe-highlight-function 'orderless-highlight-matches)
  (setopt affe-regexp-function 'orderless-pattern-compiler))
#+end_src

** orderless
#+begin_src emacs-lisp
(require 'orderless)
(with-eval-after-load 'minibuffer
  ;; config
  (add-to-list 'completion-styles-alist '(orderless orderless-try-completion orderless-all-completions
                                                    "Completion of multiple components, in any order."))
  (setopt completion-styles '(orderless initials flex basic))
  (setopt completion-category-overrides '((file (styles flex basic partial-completion)))))
#+end_src

** yasnippet
#+begin_src emacs-lisp
(require 'yasnippet)
(add-hook 'emacs-startup-hook #'yas-global-mode)

(require 'consult-yasnippet)
(keymap-global-set "C-c y" #'consult-yasnippet)
(keymap-global-set "C-c C-y" #'consult-yasnippet)
#+end_src
* org-mode
** org-mode
#+begin_src emacs-lisp
(setq org-directory "~/Documents/org-mode")
(setq org-archive-files (format "%s/_org_archive.org::" org-directory))

(defun create-file (filename)
  (if (not (file-exists-p filename))
      (make-empty-file filename)))
(create-file org-archive-files)

(defun create-new-org-file (path)
  (let ((name (read-string "Name: ")))
    (expand-file-name (format "%s.org"
                              name) path)))

(require 'org)
(with-eval-after-load 'org
  (setq org-startup-folded 'content
        org-deadline-warning-day  30
        org-enforce-todo-dependencies t
        org-html-htmlize-output-type 'inline-css
        org-html-htmlize-output-type nil
        org-html-htmlize-output-type 'css
        org-adapt-indentation t
        org-hide-leading-stars t
        org-hide-emphasis-markers t
        org-pretty-entities t
	    org-ellipsis "  ·"
        org-src-fontify-natively t
	    org-src-tab-acts-natively t
        org-edit-src-content-indentation 0
        org-lowest-priority ?F  ;; Gives us priorities A through F
        org-default-priority ?E ;; If an item has no priority, it is considered [#E].
        org-use-sub-superscripts '{}
        org-export-with-sub-superscripts nil
        org-priority-faces '((65 . "#BF616A")
                             (66 . "#EBCB8B")
                             (67 . "#B48EAD")
                             (68 . "#81A1C1")
                             (69 . "#5E81AC")
          (70 . "#4C566A"))
        org-todo-keywords
        '((sequence "TODO(t)" "DOING(n)" "WAIT(w)" "|" "DONE(d)"))
        org-todo-keyword-faces
        '(("TODO"   :foreground "#A3BE8C" :weight bold)
          ("DOING"  :foreground "#88C0D0" :weight bold)
		  ("WAIT"   :foreground "#88C0D0" :weight bold)
          ("DONE"   :foreground "#ff40ff" :weight bold))
        org-tag-alist '(("Lab" . ?l) ("RA" . ?r) ("Private" . ?p))
        org-global-properties '(("Effort_ALL" . "0 0:30 1:00 1:30 2:00 2:30"))
        org-archive-location org-archive-files)
  
  (add-hook 'org-mode-hook 'visual-line-mode)
  
  (dolist (face '((org-level-1 . 1.35)
                  (org-level-2 . 1.3)
                  (org-level-3 . 1.2)
                  (org-level-4 . 1.1)
                  (org-level-5 . 1.1)
                  (org-level-6 . 1.1)
                  (org-level-7 . 1.1)
                  (org-level-8 . 1.1)))))
#+end_src

** org-capture
#+begin_src emacs-lisp
(setq org-memo-file (format "%s/memo.org" org-directory)
      org-prj-dir (format "%s/projects" org-directory)
      org-misc-file (format "%s/projects/misc.org" org-directory)
      org-diary-file (format "%s/diary.org" org-directory)
      org-weekly-log-file (format "%s/weekly-log.org" org-directory)
      org-weekly-todo (format "%s/weekly-todo.org" org-directory))
(mapc #'create-file
      (list org-memo-file org-misc-file org-diary-file org-weekly-log-file org-weekly-todo))

(with-eval-after-load 'org
  (setq org-capture-templates 
        '(("m" "Memo" entry (file org-memo-file) "** %U\n" :empty-lines 1)
          ("t" "Tasks" entry (file org-misc-file) "** TODO %?")
          ("d" "Diary" entry (file org-diary-file) "** %<%Y-%m-%d> \n\n%?" :empty-lines 1)
          ("p" "Projects" entry (file
                                 (lambda () (create-new-org-file
                                             org-prj-dir)))
           "\n* %? ")
          ("w" "weekly" entry (file org-weekly-log-file) "* %<%Y-%m-%d> \n\n%?" :empty-lines 1)))
  (keymap-global-set "C-c c" #'org-capture))
#+end_src

** org-roam
#+begin_src emacs-lisp
(require 'org-roam)
(setq org-roam-db-update-method 'immediate
      org-roam-db-location (format "%s/org-roam.db" org-directory)
      org-roam-directory (format "%s/org-roam" org-directory)
      org-roam-index-file (format "%s/index.org" org-directory))
(org-roam-db-autosync-mode)
(keymap-global-set "C-c n f" #'org-roam-node-find)
(keymap-global-set "C-c n i" #'org-roam-node-insert)
(keymap-global-set "C-c n t" #'org-roam-tag-add)
(keymap-global-set "C-c n a" #'org-roam-alias-add)
#+end_src

** org-indent
#+begin_src emacs-lisp
(require 'org-indent)
(add-hook 'org-mode-hook #'org-indent-mode)
(set-face-attribute 'org-indent nil :inherit '(org-hide fixed-pitch))
(set-face-attribute 'org-block nil            :foreground nil :inherit
                    'fixed-pitch :height 1.0)
(set-face-attribute 'org-code nil             :inherit '(shadow fixed-pitch) :height 0.85)
(set-face-attribute 'org-indent nil           :inherit '(org-hide fixed-pitch) :height 0.85)
(set-face-attribute 'org-verbatim nil         :inherit '(shadow fixed-pitch) :height 0.85)
(set-face-attribute 'org-special-keyword nil  :inherit '(font-lock-comment-face
                                                         fixed-pitch))
(set-face-attribute 'org-meta-line nil        :inherit '(font-lock-comment-face fixed-pitch))
(set-face-attribute 'org-checkbox nil         :inherit 'fixed-pitch)
(add-hook 'org-mode-hook 'variable-pitch-mode)
(plist-put org-format-latex-options :scale 2)
#+end_src
** org-superstar
#+begin_src emacs-lisp
(require 'org-superstar)
(add-hook 'org-mode-hook #'org-superstar-mode)
(with-eval-after-load 'org-superstar
  (setopt org-superstart-special-todo-items " ")
  (setopt org-superstart-special-todo-items t))
#+end_src

** org-babel
#+begin_src emacs-lisp
(org-babel-do-load-languages
'org-babel-load-languages
'((python . t)
  (shell . t)))

(setq org-babel-python-command "../.venv/bin/python")
(require 'ob-core)
(with-eval-after-load 'ob-core
  (setopt org-confirm-babel-evaluate nil)
  (setopt org-babel-default-header-args '((:session . "none")
                                          (:results . "drawer replace")
                                          (:exports . "code")
                                          (:cache . "no")
                                          (:noweb . "no")
                                          (:hlines . "no")
                                          (:tangle . "no"))))
(with-eval-after-load 'ob-lisp
  (defalias 'org-babel-execute:common-lisp 'org-babel-execute:lisp))
#+end_src
** org-super-agenda
#+begin_src emacs-lisp
;(autoload-if-found '(org-agenda) "org-super-agenda" nil t)
(require 'org-super-agenda)
(org-super-agenda-mode t)
#+end_src
** org-agenda
#+begin_src emacs-lisp
(require 'org-agenda)

(with-eval-after-load 'org
  (setq org-agenda-custom-commands 
        '(("x" "Unscheduled Tasks" tags-todo
           "-SCHEDULED>=\"<today>\"-DEADLINE>=\"<today>\"" nil)
          ("v" "My super agenda"
           (
            (agenda "" ((org-agenda-span 'day)
                        (org-super-agenda-groups
                         '((:name "Today's Log"
                                  :time-grid t
                                  :date today
                                  :scheduled today
                                  :order 1)
                           (:discard (:anything t))))))
            (alltodo "" ((org-agenda-overriding-header "")
                         (org-super-agenda-groups
                          '((:auto-category t)
                            ;; (:name "今日締切のタスク"
                            ;;        :deadline today
                            ;;        :order 2)
                            ;; (:name "今日予定のタスク"
                            ;;        :scheduled today
                            ;;        :order 3)
                            ;; (:name "締切を過ぎたタスク"
                            ;;        :deadline past
                            ;;        :order 4)
                            ;; (:name "予定が近いタスク"
                            ;;        :deadline future
                            ;;        :order 5)
                            ;; (:name "研究室のTODO"
                            ;;        :tag "Lab"
                            ;;        :order 6)
                            ;; (:name "RAのTODO"
                            ;;        :tag "RA"
                            ;;        :order 7)
                            ;; (:name "PrivateのTODO"
                            ;;        :tag "Private"
                            ;;        :order 7)
                            )))))))

        org-agenda-start-on-weekday 3
        org-agenda-span 'week
        org-agenda-skip-scheduled-if-done t
        org-agenda-skip-deadline-if-done t
        org-agenda-include-deadlines t
        org-return-follows-link t  ;; RET to follow link
        org-agenda-time-grid
        '((daily today require-timed)
          (0900 1200 1300 1800) "......" "----------------")
        org-columns-default-format
        "%68ITEM(Task) %6Effort(Effort){:} %6CLOCKSUM(Clock){:}"
        org-clock-out-remove-zero-time-clocks t
        org-agenda-use-time-grid t
        org-clock-clocked-in-display 'both
        org-agenda-start-with-log-mode t
        org-agenda-files (list org-directory org-prj-dir org-roam-directory)
        org-agenda-archives-mode t))

(plist-put org-format-latex-options :scale 1.2)
(keymap-global-set "C-c a" #'org-agenda)
#+end_src

** org-pomodoro
#+begin_src emacs-lisp
(require 'org-pomodoro)
;(keymap-global-set "M-p" #'org-pomodoro)
; (global-unset-key (kbd "M-p"))
(with-eval-after-load 'org-pomodoro
  (setopt org-pomodoro-play-sournds  nil)
  (setopt org-pomodoro-finished-sound-p nil)
  (setopt org-pomodoro-short-break-sound-p nil)
  (setopt org-pomodoro-long-break-sound-p nil)
  (setopt org-pomodoro-manual-break nil)
  (setopt org-pomodoro-format "Working %s")
  (setopt org-pomodoro-length 25)
  (setopt org-pomodoro-short-break-length 5))

(defun org-pomodoro-kill ()
  "Kill the current timer, reset the phase and update the modeline."
  (org-clock-out)
  (org-pomodoro-killed))
#+end_src

** ox-gfm
#+begin_src emacs-lisp
(require 'ox-gfm)
#+end_src

** ox-hugo
#+begin_src emacs-lisp
(require 'ox-hugo)
#+end_src

** ox-typst
#+begin_src emacs-lisp
(require 'ox-typst)
#+end_src

** org-hydra
#+begin_src emacs-lisp
(defun my:org-goto-project ()
    (interactive)
    (find-file org-project-file))
(defun my:org-goto-memo ()
    (interactive)
    (find-file org-memo-file))
(defun my:org-goto-exp ()
    (interactive)
    (find-file org-exp-file))


(major-mode-hydra-define org-mode
  (:title "org mode":color blue :quit-key "q" :foreign-keys warn :separator "╌")
  ("visit file"
   (("m" my:org-goto-memo "memo"))
   "agenda"
   (("a" org-agenda "agenda")
    ("c" org-capture "capture"))
   "insert"
   (("h" org-insert-heading "header")
    ("l" org-insert-link "link")
    ("t" org-table-create "table"))
   "export"
   (("H" org-hugo-export-to-md "hugo md")
    ("d" org-export-dispatch "dispatch"))
   "move"
   (("n" org-move-subtree-down "down" :exit nil)
    ("u" org-move-subtree-up "up" :exit nil))))
#+end_src
* lsp
** lsp-mode
*** basic config
#+begin_src emacs-lisp
;; (require 'lsp-mode)
#+end_src
*** language specific config
#+begin_src emacs-lisp
#+end_src
*** lsp-booster
#+begin_src emacs-lisp
(defun lsp-booster--advice-json-parse (old-fn &rest args)
  "Try to parse bytecode instead of json."
  (or
   (when (equal (following-char) ?#)
     (let ((bytecode (read (current-buffer))))
       (when (byte-code-function-p bytecode)
         (funcall bytecode))))
   (apply old-fn args)))
(advice-add (if (progn (require 'json)
                       (fboundp 'json-parse-buffer))
                'json-parse-buffer
              'json-read)
            :around
            #'lsp-booster--advice-json-parse)

(defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
  "Prepend emacs-lsp-booster command to lsp CMD."
  (let ((orig-result (funcall old-fn cmd test?)))
    (if (and (not test?)                             ;; for check lsp-server-present?
             (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
             lsp-use-plists
             (not (functionp 'json-rpc-connection))  ;; native json-rpc
             (executable-find "emacs-lsp-booster"))
        (progn
          (when-let ((command-from-exec-path (executable-find (car orig-result))))  ;; resolve command from exec-path (in case not found in $PATH)
            (setcar orig-result command-from-exec-path))
          (message "Using emacs-lsp-booster for %s!" orig-result)
          (cons "emacs-lsp-booster" orig-result))
      orig-result)))
(advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command)
#+end_src
** eglot
*** basic
#+begin_src emacs-lisp
(require 'eglot)
(pretty-hydra-define eglot
  (:title "LSP" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
  ("peek"
   (("d" xref-find-definitions "definitions")
    ("r" xref-find-references "references")
    ("b" xref-go-back "go back"))
   "action"
   (("R" eglot-rename "rename")
    ("a" eglot-code-actions "action"))
   "search"
   (("s" consult-eglot-symbols "symbols")
    ("D" consult-flycheck "diagnostic"))
   "flycheck"
   (("n" flycheck-next-error "next")
    ("p" flycheck-previous-error "prev"))))
(keymap-global-set "C-c l" #'eglot/body)
;; Option 1: Specify explicitly to use Orderless for Eglot
(setq completion-category-overrides '((eglot (styles orderless))
                                      (eglot-capf (styles orderless))))
(with-eval-after-load 'embark
  (with-eval-after-load 'consult-eglot
    (require 'consult-eglot-embark)
    (consult-eglot-embark-mode)))
(advice-add 'eglot-completion-at-point :around #'cape-wrap-buster)

(setq eglot-connect-timeout nil)
(eglot-booster-mode)
(setq eglot-booster-io-only t)
(require 'eldoc-box)
(add-hook 'prog-mode-hook #'eldoc-box-hover-at-point-mode)
#+end_src

*** language specific config
#+begin_src emacs-lisp
(add-hook 'rust-mode-hook #'eglot-ensure)
; ref https://syohex.hatenablog.com/entry/2022/11/08/000610
(defun my/find-rust-project-root (dir)
  (when-let ((root (locate-dominating-file dir "Cargo.toml")))
    (list 'vc 'git root)))

(defun my/rust-mode-hook ()
  (setq-local project-find-functions (list #'my/find-rust-project-root)))
  
(add-hook 'rust-mode-hook #'my/rust-mode-hook)

(add-hook 'python-mode-hook #'eglot-ensure)

(add-hook 'nix-mode-hook #'eglot-ensure)

(add-hook 'typst-ts-mode-hook #'eglot-ensure)
(add-hook 'typst-ts-mode-hook #'eldoc-box-hover-at-point-mode)
(with-eval-after-load 'typst-ts-mode
  (add-to-list 'eglot-server-programs
               `((typst-ts-mode) .
                 ,(eglot-alternatives `(,typst-ts-lsp-download-path
                                        "tinymist"))))
  ;; (setq-default eglot-workspace-configuration
  ;;               '(:tinymist (:exportPdf "onSave")))
  (setq-default eglot-workspace-configuration
                '(:tinymist (:formatterMode "typstyle")))
  (setq-local eglot-ignored-server-capabilities '(:hoverProvider)))




(add-to-list 'eglot-server-programs
             '(yatex-mode . ("texlab")))
(add-hook 'yatex-mode-hook #'eglot-ensure)
#+end_src

** lsp-bridge
*** basic config
#+begin_src emacs-lisp
;; (require 'lsp-bridge)

;; (pretty-hydra-define lsp-bridge
;;   (:title "LSP" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
;;   ("peek"
;;    (("d" lsp-bridge-find-def "def")
;;     ("r" lsp-bridge-find-references "ref")
;;     ("i" lsp-bridge-find-impl "impl")
;;     ("s" lsp-bridge-workspace-list-symbols "symbols")
;;     ("b" xref-go-back "go back"))
;;    "action"
;;    (("R" lsp-bridge-rename "rename")
;;     ("a" lsp-bridge-code-action "action"))
;;    "diagnostic"
;;    (("D" lsp-bridge-diagnostic-list "diagnostic")
;;     ("n" lsp-bridge-diagnostic-jump-next "next")
;;     ("p" lsp-bridge-diagnostic-jump-prev "prev"))))
;; (keymap-global-set "C-c l" #'lsp-bridge/body)

;; (with-eval-after-load 'lsp-bridge
;;   (setq acm-enable-tabnine                  nil
;;         acm-enable-copilot                  nil
;;         acm-enable-quick-access             t
;;         acm-backend-yas-candidates-number   5
;;         acm-candidate-match-function 'orderless-literal
;;         acm-backend-lsp-show-progress t
;;         lsp-bridge-enable-hover-diagnostic  t
;;         lsp-bridge-enable-inlay-hint t
;;         lsp-bridge-diagnostic-fetch-idle 0.1
;;         lsp-bridge-log-level ""
;;         lsp-bridge-enable-auto-format-code nil))
#+end_src

*** language specific config
#+begin_src emacs-lisp
;; (defun my/find-cargo-root (filename)
;;   (expand-file-name
;;    (locate-dominating-file filename "Cargo.toml")))

;; (add-hook 'rust-mode-hook
;;           (lambda ()
;;             (setq-local lsp-bridge-get-project-path-by-filepath #'my/find-cargo-root)
;;             (lsp-bridge-mode)))

;; (add-hook 'python-mode-hook
;;           (lambda ()
;;             (remove '((python-mode python-ts-mode) . lsp-bridge-python-multi-lsp-server) lsp-bridge-multi-lang-server-mode-list)
;;             (lsp-bridge-mode)))


;; (add-hook 'nix-mode-hook #'lsp-bridge-mode)
;; (add-hook 'yatex-mode-hook #'lsp-bridge-mode)
;; (add-hook 'typst-ts-mode-hook #'lsp-bridge-mode)
#+end_src

** flycheck
#+begin_src emacs-lisp
; grammar check
(require 'flycheck)
(add-hook 'emacs-startup-hook #'global-flycheck-mode)
(with-eval-after-load 'flycheck
  (require 'flycheck-posframe)
  (add-to-list 'flycheck-textlint-plugin-alist '(yatex-mode . "latex2e"))
  (add-hook 'flycheck-mode-hook #'flycheck-posframe-mode))
#+end_src

#+begin_src emacs-lisp
(require 'highlight-indent-guides)
(add-hook 'prog-mode-hook #'highlight-indent-guides-mode)
#+end_src
** dap
#+begin_src emacs-lisp
(require 'dap-mode)
(require 'dap-hydra)
(require 'dap-ui)

(with-eval-after-load 'dap-mode
  ;; keybind
  (define-key dap-mode-map (kbd "C-c d") #'dap-breakpoint-toggle)

  ;; hooks
  (add-hook 'dap-mode-hook #'dap-ui-mode)
  (add-hook 'dap-mode-hook #'dap-ui-controls-mode)
  (add-hook 'dap-stopped-hook #'(lambda (arg) (call-interactively #'dap-hydra))))
#+end_src
* Program
** formatter
#+begin_src emacs-lisp
(require 'reformatter)
#+end_src
** langs
*** csv mode
#+begin_src emacs-lisp
(require 'csv-mode)
(add-to-list 'auto-mode-alist '("\\.csv$" . csv-mode))

(with-eval-after-load 'csv-mode
  ;; hook
  (add-hook 'csv-mode-hook #'view-mode))
#+end_src
*** docker compose mode
#+begin_src emacs-lisp
(require 'docker-compose-mode)

(add-to-list 'auto-mode-alist '("\\docker-compose*" . docker-compose-mode))

(with-eval-after-load 'docker-compose-mode
  ;; hook
  (add-hook 'docker-compose-mode-hook #'view-mode))
#+end_src
*** dockerfile mode
#+begin_src emacs-lisp
(require 'dockerfile-mode)

(add-to-list 'auto-mode-alist '("\\Dockerfile$" . dockerfile-mode))
(add-to-list 'auto-mode-alist '("\\Dockerfile.dev$" . dockerfile-mode))
(add-to-list 'auto-mode-alist '("\\Dockerfile_Ecs$" . dockerfile-mode))
(add-to-list 'auto-mode-alist '("\\Dockerfile_EcsDeploy" . dockerfile-mode))

(with-eval-after-load 'dockerfile-mode
  ;; hooks
  (add-hook 'dockerfile-mode-hook #'flycheck-mode))
#+end_src
*** dotenv mode
#+begin_src emacs-lisp
(require 'dotenv-mode)

(add-to-list 'auto-mode-alist '(".env$" . dotenv-mode))

(with-eval-after-load 'dotenv-mode
  (add-hook 'dotenv-mode-hook #'view-mode))
#+end_src
*** git mode
#+begin_src emacs-lisp
(require 'git-modes)
;; gitignore-mode
(add-to-list 'auto-mode-alist '("\\.dockerignore$" . gitignore-mode))
(add-to-list 'auto-mode-alist '("\\.gitignore$" . gitignore-mode))
(add-to-list 'auto-mode-alist '("\\.prettierignore$" . gitignore-mode))
(add-to-list 'auto-mode-alist '("/git/ignore\\'" . gitignore-mode))
(add-to-list 'auto-mode-alist '("/git/ignore\\'" . gitignore-mode))
(add-to-list 'auto-mode-alist '("CODEOWNERS" . gitignore-mode))

(with-eval-after-load 'gitignore-mode
  ;; hook
  (add-hook 'gitignore-mode-hook #'view-mode))

;; gitconfig-mode
(add-to-list 'auto-mode-alist '("\\.git-pr-release$" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("\\.editorconfig$" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("\\.gitconfig$" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("/\\.git/config\\'" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("/modules/.*/config\\'" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("/git/config\\'" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("/\\.gitmodules\\'" . gitconfig-mode))
(add-to-list 'auto-mode-alist '("/etc/gitconfig\\'" . gitconfig-mode))

(with-eval-after-load 'gitconfig-mode
  ;; hook
  (add-hook 'gitconfig-mode-hook #'view-mode))

;; gitattributes
(add-to-list 'auto-mode-alist '("/\\.gitattributes\\'" . gitattributes-mode))
(add-to-list 'auto-mode-alist '("\.gitattributes$" . gitattributes-mode))
(add-to-list 'auto-mode-alist '("/info/attributes\\'" . gitattributes-mode))
(add-to-list 'auto-mode-alist '("/git/attributes\\'" . gitattributes-mode))

(with-eval-after-load 'gitattributes-mode
  ;; hook
  (add-hook 'gitattributes-mode-hook #'view-mode))
#+end_src
*** json mode
#+begin_src emacs-lisp
(require 'json-mode)
(add-to-list 'auto-mode-alist '("\\.json$" . json-mode))
(add-to-list 'auto-mode-alist '("\\.textlintrc$" . json-mode))
(add-to-list 'auto-mode-alist '("\\.prettierrc$" . json-mode))
(add-to-list 'auto-mode-alist '("\\.markuplintrc$" . json-mode))

(with-eval-after-load 'json-mode
  ;; hooks
  (add-hook 'json-mode-hook #'flycheck-mode))

#+end_src
*** rust mode
**** basic and lsp
#+begin_src emacs-lisp
(require 'rust-mode)
(require 'cargo)
(add-hook 'rust-mode-hook #'cargo-minor-mode)
(with-eval-after-load 'rust-mode
  (add-hook 'flycheck-mode-hook #'flycheck-rust-setup))

(with-eval-after-load 'rust-mode
  (setq rust-format-on-save t
        rust-mode-treesitter-derive t))
#+end_src
**** hydra-menu
#+begin_src emacs-lisp
(major-mode-hydra-define rust-mode
  (:title "Rust" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
  ("run"
   (("r" rust-run "run")
    ("c" rust-compile "compile")
    ("t" rust-test "test")
    ("c" rust-check "check"))))
#+end_src

*** ssh config mode
*** python mode
**** basic and lsp
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.py$" . python-mode))

(with-eval-after-load 'python-mode
  (setopt python-shell-completion-native-enable nil))
#+end_src
**** formatter
#+begin_src emacs-lisp
(reformatter-define python-isort-format
  :program "isort"
  :args '("-")
  :stdin t  ; バッファ内容を標準入力 (STDIN) に渡す
  :lighter "isort"
  :group 'python-isort)
(add-hook 'python-mode-hook #'python-isort-format-on-save-mode)

(reformatter-define python-ruff-format
  :program "ruff"
  :args `("format" "--stdin-filename" ,buffer-file-name))
(add-hook 'python-mode-hook #'python-ruff-format-on-save-mode)
(setq python-pytest-executable "uv run pytest")
#+end_src
**** DAP
#+begin_src emacs-lisp
(require 'dap-python)
;; if you installed debugpy, you need to set this
;; https://github.com/emacs-lsp/dap-mode/issues/306
(setq dap-python-debugger 'debugpy)
(add-hook 'python-mode-hook '(lambda ()
                               (setq dap-python-executable (format "%s.venv/bin/python" (projectile-project-root)))))
#+end_src
**** uv config
#+begin_src emacs-lisp
(defcustom uv-command "uv"
  "command for running uv"
  :type 'string)
(defcustom uv-command--remove "remove"
  "subcommand to remove packages"
  :type 'string)
(defcustom uv-command--add "add"
  "subcommand to add new package"
  :type 'string)
(defcustom uv-command--list-pack "pip list"
  "subcommand to list packages in .venv"
  :type 'string)

(defun uv-list-packages ()
  (interactive)
  (if (uv-project-root-p)
      (let* ((output (shell-command-to-string
                      (concat uv-command " " uv-command--list-pack)))
             (lines (cddr (split-string output "\n" t)))
             (installed-packages (mapcar (lambda (line)
                                           (car (split-string line " " t)))
                                         lines)))
        (when (called-interactively-p 'interactive)
          (print installed-packages))
        installed-packages)))

; check the existence of pyproject.toml in projectile-project-root
(defun uv-project-root-p ()
  (interactive)
  (file-exists-p
   (format "%spyproject.toml" (projectile-project-root))))

(defun uv-package-existance-p (package-name)
  (member package-name (uv-list-packages)))

(defun uv-remove-package ()
  "function to remove package in current project"
  ; パッケージの存在
  (if (uv-project-root-p)
      (let* ((package-name (read-string "Package Name: ")))
        (if (not (uv-package-existance-p package-name))
            (message "%s does not exist in current project" package-name)
          (shell-command
           (concat uv-command " " uv-command--remove " " package-name ))))))

(defun uv-add-package ()
  "function to add new package in current project"
  ; パッケージが存在する時も実行しない
  (if (uv-project-root-p)
      (let* ((package-name (read-string "Package Name: ")))
        (if (uv-package-existance-p package-name)
            (message "%s is already installed in current project" package-name)
          (shell-command
           (concat uv-command " " uv-command--add " " package-name))))))
#+end_src

**** hydra menu
#+begin_src emacs-lisp
(major-mode-hydra-define python-mode
  (:title "Python" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
  ("run"
   (("t" python-pytest-dispatch "test"))
   "package(uv)"
   (("a" uv-add-package "add")
    ("r" uv-remove-package "remove"))))
#+end_src
*** nix mode
#+begin_src emacs-lisp
(add-to-list 'auto-mode-alist '("\\.nix$" . nix-mode))

(reformatter-define nix-alejandra-format
  :program "alejandra")
(add-hook 'nix-mode-hook #'nix-alejandra-format-on-save-mode)
#+end_src
*** toml mode
#+begin_src emacs-lisp
(require 'toml-mode)

(add-to-list 'auto-mode-alist '("\\.toml$" . toml-mode))

(with-eval-after-load 'toml-mode
  ;; hooks
  (add-hook 'toml-mode-hook #'flycheck-mode)
  (add-hook 'toml-mode-hook #'view-mode))
#+end_src
*** yaml mode
#+begin_src emacs-lisp
(require 'yaml-mode)
(add-to-list 'auto-mode-alist '("\\.ya?ml$" . yaml-mode))
(add-to-list 'auto-mode-alist '("\\.aclpolicy$" . yaml-mode))

(with-eval-after-load 'yaml-mode
  ;; hooks
  (add-hook 'yaml-mode-hook #'flycheck-mode)
  (add-hook 'yaml-mode-hook #'view-mode))
#+end_src

* Typset
** typst mode
#+begin_src emacs-lisp
(require 'typst-ts-mode)
(add-to-list 'auto-mode-alist '("\\.typ\\'" . typst-ts-mode))

(major-mode-hydra-define typst-ts-mode
  (:title "Typst" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
  ("menu"
   (("c" typst-ts-compile "compile")
    ("p" typst-ts-preview "preview"))))
#+end_src

** yatex
#+begin_src emacs-lisp
(require 'yatex)
(add-to-list 'auto-mode-alist '("\\.tex$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.ltx$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.cls$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.sty$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.clo$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.bbl$" . yatex-mode))
(add-to-list 'auto-mode-alist '("\\.bib$" . yatex-mode))

(add-hook 'yatex-mode-hook #'yas-minor-mode)

(with-eval-after-load 'yatex
  (setopt YaTeX-inhibit-prefix-letter  t)
  (setopt tex-command  "platex -kanji=utf8")
  (setopt YaTeX-dvi2-command-ext-alist
     '(("Skim" . ".pdf")))
  (setopt dvi2-command "open -a Skim")
  (setopt tex-pdfview-command "open -a Skim")
  (major-mode-hydra-define yatex-mode
     (:title "Yatex" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
   ("reftex"
    (("r" reftex-citation "references")
     ("t" reftex-toc "toc"))
    "yatex"
    (("m" YaTeX-typeset-menu "typeset")
     ("b" YaTeX-make-begin-end "begin env")
     ("s" YaTeX-make-section "section env")))))
#+end_src
** flyspell
#+begin_src emacs-lisp
(require 'flyspell)
(add-hook 'yatex-mode-hook #'flyspell-mode)
#+end_src

** reftex

#+begin_src emacs-lisp
(require 'reftex)
(add-to-list 'yatex-mode-hook #'reftex-mode)
(add-hook 'reftex-mode-hook '(lambda()
                               (setq reftex-default-bibliography
                                     (let ((root (projectile-project-root)))
                                       (when root
                                         (directory-files-recursively root "\\.bib$"))))))
#+end_src

* ddskk
#+begin_src emacs-lisp
(require 'ddskk-autoloads)
(keymap-global-set "C-x j" #'skk-mode)
(keymap-global-set "C-x C-j" #'skk-mode)
(setq default-input-method "japanese-skk")

(setq skk-mode-hook
      '(lambda()
         (advice-add 'skk-open-server :override 'skk-open-server-decoding-utf-8)))

(setq skk-preload t)

(with-eval-after-load 'skk-vars
  (setq skk-large-jisyo "~/.skk-dict/SKK-JISYO.L"
        skk-use-azik t
        skk-azik-keyboard-type "en"
        skk-search-katakana nil
        skk-share-private-jisyo t
        skk-save-jisyo-instantly t
        skk-server-host "localhost"
        skk-server-portnum 1178))
  ;; (delete '("'" nil "ー") skk-rom-kana-rule-list)
  ;; (delete '("[" nil skk-toggle-characters) skk-rom-kana-rule-list)
  ;; (add-to-list 'skk-rom-kana-rule-list '("'" nil skk-toggle-characters)))

(require 'ddskk-posframe)

(with-eval-after-load 'skk
  ;; hooks
  (add-hook 'skk-mode-hook #'ddskk-posframe-mode)
  (keymap-global-set "C-l" #'skk-latin-mode))
#+END_SRC

* copilot
#+begin_src emacs-lisp
(setq copilot-indent-offset-warning-disable t)
(require 'copilot)
(require 'copilot-chat)
(add-hook 'prog-mode-hook 'copilot-mode)
(keymap-global-set "C-<tab>" #'copilot-accept-completion)
;(define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
#+end_src
* hydra menu 
#+begin_src emacs-lisp
(pretty-hydra-define hydra-goto
  (:title "↗ Goto" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
   ("Got"
    (("i" avy-goto-char       "char")
     ("t" avy-goto-char-timer "timer")
     ("l" avy-goto-line       "line")
     ("j" avy-resume          "resume"))
    "Line"
    (("h" avy-goto-line        "head")
     ("e" avy-goto-end-of-line "end")
     ("n" consult-goto-line    "number"))
    "Topic"
    (("o"  consult-outline      "outline")
     ("m"  consult-imenu        "imenu")
     ("g" consult-global-imenu "global imenu"))
    "Error"
    ((","  lsp-bridge-diagnostic-jump-prev "previous")
     ("."  lsp-bridge-diagnostic-jump-next "next")
     ("L"  lsp-bridge-diagnostic-list "list"))
    "Spell"
    ((">"  flyspell-goto-next-error "next" :exit nil)
     ("cc" flyspell-correct-at-point "correct" :exit nil))))
(keymap-global-set "M-j" #'hydra-goto/body)
#+end_src

#+begin_src emacs-lisp
(pretty-hydra-define hydra-edit
  (:title "edit" :color blue :quit-key "q" :foreign-key warn :separator "-")
  ("Puni"
   (("f" puni-slurp-forward "forward" :exit nil)
    ("b" puni-barf-forward "backward" :exit nil)
    ("r" puni-wrap-round "round" :exit nil)
    ("s" puni-slice "slice" :exit nil)
    ("R" puni-raise "raise" :exit nil)
    ("u" puni-splice-killing-backward "kill backward" :exit nil)
    ("z" puni-squeeze "squeeze" :exit nil))
   "String"
   (("S" replace-string "replace")
    ("U" undo-tree-visualize "undo"))
   "Macros"
   (("i" reload-init-file "reload init.el")
    ("d" dmacro-exec "exec dmacro" :exit nil))))
(keymap-global-set "C-M-;" #'hydra-edit/body)
#+end_src

#+begin_src emacs-lisp
(pretty-hydra-define hydra-toggle2
  (:title " Toggle" :color blue :quit-key "q" :foreign-keys warn :separator "-")
   ("Basic"
    (("v" view-mode "view mode" :toggle t)
     ("w" whitespace-mode "whitespace" :toggle t)
     ("W" whitespace-cleanup "whitespace cleanup")
     ("r" rainbow-mode "rainbow" :toggle t)
     ("b" beacon-mode "beacon" :toggle t)
     ("o" olivetti-mode "olivetti" :toggle t))
    "Line & Column"
    (("l" toggle-truncate-lines "truncate line" :toggle t)
     ("n" display-line-numbers-mode "line number" :toggle t)
     ("F" display-fill-column-indicator-mode "column indicator" :toggle t)
     ("f" visual-fill-column-mode "visual column" :toggle t)
     ("c" toggle-visual-fill-column-center "fill center"))
    "Highlight"
    (("h" highlight-symbol "highligh symbol" :toggle t)
     ("L" hl-line-mode "line" :toggle t)
     ("t" hl-todo-mode "todo" :toggle t)
     ("g" git-gutter-mode "git gutter" :toggle t)
     ("i" highlight-indent-guides-mode "indent guide" :toggle t))
    "Window"
    (("t" toggle-window-transparency "transparency" :toggle t)
     ("m" toggle-window-maximize "maximize" :toggle t)
     ("p" presentation-mode "presentation" :toggle t))))
(keymap-global-set "M-t" #'hydra-toggle2/body)
#+end_src

#+begin_src emacs-lisp
(pretty-hydra-define hydra-search
  (:title "🔍 Search" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
   ("Buffer"
    (("l" consult-line "line")
     ("o" consult-outline "outline")
     ("m" consult-imenu "imenu"))
    "Project"
    (("f" affe-find "find")
     ("r" affe-grep "grep"))
    "Document"
    (("df" consult-find "find")
     ("dd" consult-grep "grep"))))
(keymap-global-set "C-s" #'hydra-search/body)
#+end_src

#+begin_src emacs-lisp
(pretty-hydra-define hydra-git
  (:title " Git" :color blue :quit-key "q" :foreign-keys warn :separator "╌")
   ("Basic"
    (("w" magit-checkout "checkout")
     ("s" magit-status "status")
     ("b" magit-branch "branch")
     ("F" magit-pull "pull")
     ("f" magit-fetch "fetch")
     ("A" magit-apply "apply")
     ("c" magit-commit "commit")
     ("P" magit-push "push"))
    ""
    (("d" magit-diff "diff")
     ("l" magit-log "log")
     ("r" magit-rebase "rebase")
     ("z" magit-stash "stash")
     ("!" magit-run "run command")
     ("y" magit-show-refs "references"))
    "Hunk"
    (("," git-gutter:previous-hunk "previous" :exit nil)
     ("." git-gutter:next-hunk "next" :exit nil)
     ("g" git-gutter:stage-hunk "stage")
     ("v" git-gutter:revert-hunk "revert")
     ("p" git-gutter:popup-hunk "popup"))
    " GitHub"
    (("C" checkout-gh-pr "checkout PR")
     ("o" browse-at-remote-or-copy"browse at point")
     ("k" browse-at-remote-kill "copy url")
     ("O" (shell-command "hub browse") "browse repository"))))
(keymap-global-set "M-g" #'hydra-git/body)
(keymap-global-set "M-\'" #'major-mode-hydra)
#+end_src

* OJ
#+begin_src emacs-lisp
(require 'oj)
(setopt oj-home-dir
        (expand-file-name "~/ghq/github.com/keimoriyama/Atcoder/"))
(setq oj-default-online-judge 'atcoder)
#+end_src
